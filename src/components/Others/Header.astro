---
import "@styles/header.css";
import TicketIcon from "@img/icons/ticket.svg?raw";
import UsersIcon from "@img/icons/users.svg?raw";
import ShieldIcon from "@img/icons/shield.svg?raw";
import ShoppingIcon from "@img/icons/shopping.svg?raw";
import MenuIcon from "@img/icons/menu.svg?raw";
import CloseIcon from "@img/icons/close.svg?raw";
---

<header class="main-header">
  <div class="logo">
    <a href="#intro" class="logo isotipo">LAREIRA CONF</a>
  </div>

  <button class="hamburger" aria-label="Toggle menu" aria-expanded="false">
    <span class="hamburger__icon hamburger__icon--menu" set:html={MenuIcon} />
    <span class="hamburger__icon hamburger__icon--close" set:html={CloseIcon} />
  </button>

  <nav class="main-nav">
    <a href="#tickets" class="cta-button">
      <span class="cta-button__icon" aria-hidden="true" set:html={TicketIcon} />
      <span>Entradas</span>
    </a>
    <a href="#sponsors" class="cta-button">
      <span
        class="cta-button__icon"
        aria-hidden="true"
        set:html={ShoppingIcon}
      />
      <span>Patrocinadores</span>
    </a>
    <a href="#team" class="cta-button">
      <span class="cta-button__icon" aria-hidden="true" set:html={UsersIcon} />
      <span>Equipo</span>
    </a>
    <!-- <a href="#comunidades" class="cta-button">
      <span class="cta-button__icon" aria-hidden="true" set:html={ShieldIcon} />
      <span>Comunidades</span>
    </a> -->
  </nav>
</header>

<script>
  // Hamburger menu
  const hamburger = document.querySelector(".hamburger");
  const mainNav = document.querySelector(".main-nav");

  hamburger?.addEventListener("click", () => {
    const isOpen = hamburger.getAttribute("aria-expanded") === "true";
    hamburger.setAttribute("aria-expanded", String(!isOpen));
    hamburger.classList.toggle("hamburger--open");
    mainNav?.classList.toggle("main-nav--open");
  });

  // Close menu when clicking on a link
  const navLinks = document.querySelectorAll(".main-nav a");
  navLinks.forEach((link) => {
    link.addEventListener("click", () => {
      hamburger?.classList.remove("hamburger--open");
      mainNav?.classList.remove("main-nav--open");
      hamburger?.setAttribute("aria-expanded", "false");
    });
  });

  const HORIZONTAL_NAV_RETRY_LIMIT = 20;
  const HORIZONTAL_NAV_RETRY_DELAY = 75;

  const isHorizontalLayout = () => window.innerWidth > 768;

  const scrollToTarget = (selector) => {
    const cleanId = selector.replace(/^#/, "");
    const targetEl = document.getElementById(cleanId);
    if (!targetEl) return false;

    targetEl.scrollIntoView({ behavior: "smooth", block: "start" });
    return true;
  };

  const buildUrlWithHash = (hash) =>
    `${window.location.pathname}${window.location.search}${hash}`;

  const updateUrlHash = (hash, { replace = false } = {}) => {
    if (!hash) return;
    const normalizedHash = hash.startsWith("#") ? hash : `#${hash}`;
    const url = buildUrlWithHash(normalizedHash);
    const state = { anchor: normalizedHash };

    if (replace || window.location.hash === normalizedHash) {
      window.history.replaceState(state, "", url);
    } else {
      window.history.pushState(state, "", url);
    }
  };

  const navigateToHash = (
    hash,
    { updateHistory = false, replace = false, attempt = 0 } = {},
  ) => {
    if (!hash) return false;

    const normalizedHash = hash.startsWith("#") ? hash : `#${hash}`;
    const finalize = () => {
      if (updateHistory) {
        updateUrlHash(normalizedHash, { replace });
      }
    };

    if (isHorizontalLayout()) {
      const navigator = window.horizontalPanelNav?.goToPanel;
      if (typeof navigator === "function") {
        navigator(normalizedHash);
        finalize();
        return true;
      }

      if (updateHistory && attempt === 0) {
        updateUrlHash(normalizedHash, { replace });
      }

      if (attempt < HORIZONTAL_NAV_RETRY_LIMIT) {
        window.setTimeout(() => {
          navigateToHash(normalizedHash, {
            updateHistory,
            replace,
            attempt: attempt + 1,
          });
        }, HORIZONTAL_NAV_RETRY_DELAY);
      }

      return false;
    }

    const scrolled = scrollToTarget(normalizedHash);
    if (scrolled) {
      finalize();
    }

    return scrolled;
  };

  const handleNavClick = (event) => {
    const target = event.currentTarget;
    if (!(target instanceof HTMLAnchorElement)) {
      return;
    }

    const href = target.getAttribute("href");
    if (!href || !href.startsWith("#")) {
      return;
    }

    const navigated = navigateToHash(href, { updateHistory: true });

    if (navigated) {
      event.preventDefault();
    } else if (isHorizontalLayout()) {
      event.preventDefault();
    }
  };

  const setupHeaderNav = () => {
    const links = document.querySelectorAll(".main-header a[href^='#']");
    links.forEach((link) => {
      link.removeEventListener("click", handleNavClick);
      link.addEventListener("click", handleNavClick);
    });
  };

  const applyInitialHash = () => {
    if (!window.location.hash) return;
    navigateToHash(window.location.hash, {
      updateHistory: false,
      replace: true,
    });
  };

  const handlePopState = (event) => {
    const hash = event.state?.anchor ?? window.location.hash;
    if (hash) {
      navigateToHash(hash, { updateHistory: false, replace: true });
    } else {
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  };

  const init = () => {
    setupHeaderNav();
    applyInitialHash();
  };

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init, { once: true });
  } else {
    init();
  }

  window.addEventListener("resize", () => {
    if (!isHorizontalLayout()) return;
    setupHeaderNav();
    if (window.location.hash) {
      navigateToHash(window.location.hash, {
        updateHistory: false,
        replace: true,
      });
    }
  });

  window.addEventListener("hashchange", () => {
    if (!window.location.hash) {
      window.scrollTo({ top: 0, behavior: "smooth" });
      return;
    }

    navigateToHash(window.location.hash, {
      updateHistory: false,
      replace: true,
    });
  });

  window.addEventListener("popstate", handlePopState);
</script>
